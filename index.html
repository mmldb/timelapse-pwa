<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAPSULE (N)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:,">
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- NOTHING OS THEME --- */
        :root {
            --bg: #000000;
            --fg: #ffffff;
            --dim: #555555;
            --red: #D71921; /* Nothing Red */
            --border: 1px dashed #333; /* Dotted borders */
            --font-head: 'DotGothic16', sans-serif;
            --font-body: 'Space Mono', monospace;
        }

        body { 
            margin: 0; background: var(--bg); color: var(--fg); 
            font-family: var(--font-body); font-size: 13px;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT --- */
        header { 
            padding: 15px; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 40;
        }

        h1, h2, h3 { font-family: var(--font-head); font-weight: 400; letter-spacing: 1px; margin: 0; }
        
        /* Dropdowns & Inputs with BOX BORDERS */
        select, input {
            background: black; color: white;
            border: 1px solid #333; border-radius: 0; /* Sharp edges */
            padding: 8px 12px; font-family: var(--font-body);
            outline: none;
        }
        select:focus, input:focus { border-color: var(--red); }

        /* --- VIEWFINDER (Full Screen) --- */
        .viewport { 
            flex-grow: 1; position: relative; background: #000; 
            overflow: hidden;
            /* Center the mask inside the viewport */
            display: flex; justify-content: center; align-items: center; 
        }
        
        /* Video Fills Screen */
        video { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; object-fit: cover; 
            z-index: 1;
        }
        
        #onion-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; z-index: 10; opacity: 0; pointer-events: none; 
            filter: grayscale(100%) contrast(1.2);
        }
        
        /* 4:5 MASK (The "Window") */
        .mask-container {
            position: relative; z-index: 20; pointer-events: none;
            /* Logic: Width is relative to screen, aspect ratio forces height */
            width: 100%; 
            max-width: 600px; /* Tablet constraint */
            aspect-ratio: 4/5;
            
            /* The dark overlay outside the 4:5 box */
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.2);
            
            /* Flex to center internal overlays */
            display: flex; justify-content: center; align-items: center;
        }

        /* The Overlays sit INSIDE the 4:5 mask */
        .overlay-layer { width: 100%; height: 100%; position: relative; }
        
        .guide-face { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 180px; height: 260px; 
            border: 1px dashed var(--red); border-radius: 50%; 
            opacity: 0.8;
        }
        .guide-thirds {
            width: 100%; height: 100%; opacity: 0.3;
            background-image: 
                linear-gradient(rgba(255,255,255,0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 33.3% 33.3%;
        }

        /* --- CONTROLS --- */
        .controls { 
            padding: 20px; border-top: var(--border); background: var(--bg);
            display: flex; flex-direction: column; gap: 12px; z-index: 40;
        }

        button {
            background: transparent; color: white;
            border: 1px solid #333; padding: 14px;
            font-family: var(--font-head); font-size: 16px; 
            text-transform: uppercase; cursor: pointer;
            border-radius: 0; /* Boxy */
            transition: all 0.1s;
        }
        button:active { background: var(--red); border-color: var(--red); color: black; }
        button.primary { border-color: white; }

        /* Sliders (Nothing Style) */
        .slider-row { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #888; }
        input[type=range] { 
            -webkit-appearance: none; background: transparent; border: none; padding: 0; flex-grow: 1; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 2px; background: #333;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; margin-top: -6px;
            height: 14px; width: 14px; background: black; border: 1px solid white; border-radius: 50%;
        }

        /* Status & Modals */
        .status-bar { display: flex; justify-content: space-between; font-family: var(--font-head); color: #555; font-size: 12px; }
        
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 20px;
        }
        .modal-box { 
            width: 100%; max-width: 300px; 
            border: 1px solid white; padding: 20px; /* Box Border */
            background: black;
            display: flex; flex-direction: column; gap: 15px; 
        }

        .hidden { display: none !important; }
        canvas { display: none; }
    </style>
</head>
<body>

<div id="setup-modal" class="modal hidden">
    <div class="modal-box">
        <h2>( AUTH )</h2>
        <p style="color:#888; font-size:12px;">INPUT_DROPBOX_TOKEN</p>
        <input type="text" id="token-input" placeholder="sl.B5...">
        <button class="primary" onclick="saveToken()">CONNECT</button>
    </div>
</div>

<div id="project-modal" class="modal hidden">
    <div class="modal-box">
        <h2>( NEW_PROJECT )</h2>
        <input type="text" id="new-proj-name" placeholder="PROJECT_NAME">
        <select id="new-proj-overlay">
            <option value="guide-face">GUIDE: PORTRAIT</option>
            <option value="guide-thirds">GUIDE: GRID</option>
            <option value="guide-none">GUIDE: NONE</option>
        </select>
        <div style="display:flex; gap:10px;">
            <button class="primary" style="flex:1" onclick="saveNewProject()">CREATE</button>
            <button style="flex:1" onclick="toggleProjectModal()">X</button>
        </div>
    </div>
</div>

<header>
    <div style="display:flex; gap:10px; align-items:center;">
        <span style="font-family: var(--font-head); font-size: 18px; color: var(--red);">( C )</span>
        <select id="project-select" style="border:none; border-bottom:1px solid #333; width: auto; background: transparent;"></select>
        <button onclick="toggleProjectModal()" style="border:none; font-size:18px;">+</button>
    </div>
    <button onclick="syncProjects()" style="border:none; font-size:12px; color:#888;">( SYNC )</button>
</header>

<div class="viewport">
    <video id="video" autoplay playsinline></video>
    <img id="onion-layer" />
    
    <div class="mask-container">
        <div id="overlay-container" class="overlay-layer"></div>
    </div>
</div>

<div class="controls">
    <div id="exposure-control" class="slider-row hidden">
        <span>EV</span>
        <input type="range" id="exp-slider" step="0.5" oninput="setExposure(this.value)">
        <span id="exp-val">0</span>
    </div>

    <div class="slider-row">
        <span>GHOST</span>
        <input type="range" min="0" max="100" value="0" oninput="updateOnion(this.value)">
        <span id="onion-val">00</span>
    </div>

    <div id="cam-controls" style="display:flex; gap:10px;">
        <button class="primary" id="snap-btn" style="flex:2;">CAPTURE</button>
        <button onclick="flipCamera()" style="flex:1;">CAM</button>
    </div>

    <div id="review-panel" class="hidden" style="display: flex; gap: 10px;">
        <button onclick="retryPhoto()" style="flex:1;">RETRY</button>
        <button class="primary" onclick="uploadPhoto()" style="flex:2; border-color:var(--red); color:var(--red);">SAVE</button>
    </div>

    <div class="status-bar">
        <span id="sys-status">ONLINE</span>
        <span id="res-info">4:5</span>
    </div>
</div>

<canvas id="canvas"></canvas>

<script>
    // --- 1. SYSTEM & INIT ---
    let dbxToken = localStorage.getItem('dbx_token');
    if (!dbxToken) document.getElementById('setup-modal').classList.remove('hidden');

    const defaultProjects = [
        { id: "face-daily", name: "FACE_DAILY", overlay: "guide-face", folder: "/FaceProject" },
        { id: "landscape", name: "LANDSCAPE", overlay: "guide-thirds", folder: "/Landscape" }
    ];
    let myProjects = JSON.parse(localStorage.getItem('my_projects')) || defaultProjects;

    // --- 2. INDEXED DB ---
    let db;
    const DB_REQ = indexedDB.open("CapsuleSys", 1);
    DB_REQ.onupgradeneeded = (e) => {
        let db = e.target.result;
        if (!db.objectStoreNames.contains('ghosts')) db.createObjectStore('ghosts', { keyPath: 'id' });
    };
    DB_REQ.onsuccess = (e) => { db = e.target.result; loadGhost(select.value); };

    function saveGhost(pid, blob) {
        if(!db) return;
        db.transaction(['ghosts'], 'readwrite').objectStore('ghosts').put({ id: pid, blob: blob });
    }
    function loadGhost(pid) {
        if(!db) return;
        const req = db.transaction(['ghosts'], 'readonly').objectStore('ghosts').get(pid);
        req.onsuccess = (e) => {
            document.getElementById('onion-layer').src = req.result ? URL.createObjectURL(req.result.blob) : "";
        };
    }

    // --- 3. CAMERA & EXPOSURE ---
    let currentStream = null;
    let facingMode = "user";
    let imageCapture; // Needed for exposure cap
    const video = document.getElementById('video');

    async function startCamera(mode) {
        if(!mode) mode = facingMode;
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        facingMode = mode;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: mode, width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            currentStream = stream;

            // Check Exposure Capabilities
            const track = stream.getVideoTracks()[0];
            const caps = track.getCapabilities();
            const expSlider = document.getElementById('exp-slider');
            const expRow = document.getElementById('exposure-control');

            if (caps.exposureCompensation) {
                expRow.classList.remove('hidden');
                expSlider.min = caps.exposureCompensation.min;
                expSlider.max = caps.exposureCompensation.max;
                expSlider.step = caps.exposureCompensation.step;
                expSlider.value = 0; // Default
            } else {
                expRow.classList.add('hidden');
            }

        } catch (e) { console.error(e); }
    }

    async function setExposure(val) {
        if (!currentStream) return;
        const track = currentStream.getVideoTracks()[0];
        try {
            await track.applyConstraints({ advanced: [{ exposureCompensation: parseFloat(val) }] });
            document.getElementById('exp-val').innerText = val;
        } catch (e) { console.error("Exposure failed", e); }
    }

    function flipCamera() { startCamera(facingMode === "user" ? "environment" : "user"); }

    // --- 4. CROP & CAPTURE ---
    const canvas = document.getElementById('canvas'); 
    let currentBlob = null;

    document.getElementById('snap-btn').addEventListener('click', () => {
        // High Res Crop Logic (4:5)
        const vidW = video.videoWidth;
        const vidH = video.videoHeight;
        
        // Target is width of video, height = width * 1.25
        const targetW = vidW;
        const targetH = vidW * 1.25; 
        
        // Calculate center crop y-offset
        // Note: If the video is ultra-wide (rare on mobile), this logic holds. 
        // If video is short/squat, we might need to crop width instead.
        // Assuming mobile portrait video (9:16) which is TALLER than 4:5.
        
        const startY = (vidH - targetH) / 2;

        canvas.width = targetW;
        canvas.height = targetH;
        const ctx = canvas.getContext('2d');

        if(facingMode === "user") { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
        ctx.drawImage(video, 0, startY, targetW, targetH, 0, 0, targetW, targetH);
        
        // Temp Preview inside the mask
        const url = canvas.toDataURL('image/jpeg');
        const img = document.createElement('img');
        img.src = url; img.id = 'temp-preview';
        img.style.cssText = "position:absolute; width:100%; height:100%; object-fit:contain; z-index:30;";
        document.querySelector('.mask-container').appendChild(img);
        
        document.getElementById('cam-controls').classList.add('hidden');
        document.getElementById('review-panel').classList.remove('hidden');
        canvas.toBlob(b => currentBlob = b, 'image/jpeg', 0.95);
    });

    function retryPhoto() { 
        const p = document.getElementById('temp-preview'); if(p) p.remove();
        document.getElementById('cam-controls').classList.remove('hidden');
        document.getElementById('review-panel').classList.add('hidden');
        currentBlob = null; 
    }

    // --- 5. SYNC & UTILS ---
    const select = document.getElementById('project-select');
    
    function renderProjects() {
        select.innerHTML = "";
        myProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.innerText = p.name; select.appendChild(opt);
        });
        loadProject(myProjects[0].id);
    }
    function loadProject(id) {
        const proj = myProjects.find(p => p.id === id);
        if(!proj) return;
        const container = document.getElementById('overlay-container');
        container.className = "overlay-layer"; // Reset
        // Create inner div for face guide specifically
        container.innerHTML = `<div class="${proj.overlay}"></div>`;
        loadGhost(id);
    }
    select.addEventListener('change', (e) => loadProject(e.target.value));

    async function syncProjects() {
        const btn = document.querySelector('button[onclick="syncProjects()"]');
        btn.innerText = "( ... )";
        try {
            const res = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + dbxToken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: "", recursive: false })
            });
            const data = await res.json();
            const folders = data.entries.filter(e => e['.tag'] === 'folder');
            
            folders.forEach(f => {
                const exists = myProjects.find(p => p.folder === "/" + f.name || p.folder === f.name);
                if (!exists) {
                    const id = f.name.toLowerCase().replace(/\s+/g, '-');
                    myProjects.push({ id, name: f.name.toUpperCase(), overlay: "guide-none", folder: "/" + f.name });
                }
            });
            localStorage.setItem('my_projects', JSON.stringify(myProjects));
            renderProjects();
            btn.innerText = "( OK )"; setTimeout(() => btn.innerText = "( SYNC )", 2000);
        } catch (e) { alert("SYNC ERR"); btn.innerText = "( ERR )"; }
    }

    // --- 6. UPLOAD ---
    async function uploadPhoto() {
        if (!currentBlob) return;
        const status = document.getElementById('sys-status');
        status.innerText = "UPLOADING...";
        
        const pid = select.value;
        const proj = myProjects.find(p => p.id === pid);
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timestamp = now.toISOString(); // 2026-02-04T22:45:12.550Z

        try {
            saveGhost(pid, currentBlob);
            
            // Weather
            let temp = "N/A";
            try {
                const pos = await new Promise((r, j) => navigator.geolocation.getCurrentPosition(r, j, {timeout:2000}));
                const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)).json();
                temp = w.current_weather.temperature + "C";
            } catch(e){}

            await sendToDropbox(currentBlob, `${proj.folder}/${pid}-${dateStr}.jpg`);
            const meta = { timestamp: timestamp, project: pid, temp: temp, cam: facingMode };
            await sendToDropbox(new Blob([JSON.stringify(meta)],{type:'application/json'}), `${proj.folder}/${pid}-${dateStr}.json`);

            retryPhoto(); status.innerText = "SAVED"; setTimeout(() => status.innerText = "ONLINE", 2000);
        } catch(e) { 
            alert(e.message); status.innerText = "ERROR"; 
        }
    }

    async function sendToDropbox(f, p) {
        const r = await fetch('https://content.dropboxapi.com/2/files/upload', { 
            method: 'POST', 
            headers: { 'Authorization': 'Bearer '+localStorage.getItem('dbx_token'), 'Content-Type': 'application/octet-stream', 'Dropbox-API-Arg': JSON.stringify({ path: p, mode: 'add', autorename: true }) }, 
            body: f 
        });
        if(!r.ok) throw new Error(await r.text());
    }

    function toggleProjectModal() { document.getElementById('project-modal').classList.toggle('hidden'); }
    function saveToken() { const t = document.getElementById('token-input').value.trim(); if(t) { localStorage.setItem('dbx_token', t); location.reload(); } }
    function saveNewProject() {
        const name = document.getElementById('new-proj-name').value;
        const overlay = document.getElementById('new-proj-overlay').value;
        if(!name) return;
        const id = name.toLowerCase().replace(/\s+/g, '-');
        myProjects.push({ id, name: name.toUpperCase(), overlay, folder: "/" + name.replace(/\s+/g, '') });
        localStorage.setItem('my_projects', JSON.stringify(myProjects));
        renderProjects(); select.value = id; loadProject(id); toggleProjectModal();
    }
    function updateOnion(val) { document.getElementById('onion-layer').style.opacity = val / 100; document.getElementById('onion-val').innerText = val.padStart(2, '0'); }

    if(dbxToken) { startCamera(); renderProjects(); }
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
