<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAPSULE v0.5</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:,">
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- MONOCHROME INDUSTRIAL THEME --- */
        :root {
            --bg: #000000;
            --fg: #ffffff;
            --dim: #444444;
            --border: 1px dashed #333; 
            --font-head: 'DotGothic16', sans-serif;
            --font-body: 'Space Mono', monospace;
        }

        body { 
            margin: 0; background: var(--bg); color: var(--fg); 
            font-family: var(--font-body); font-size: 13px;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            -webkit-font-smoothing: antialiased;
        }

        /* --- LAYOUT --- */
        header { 
            padding: 15px; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.9); z-index: 40;
        }
        
        select, input {
            background: black; color: white;
            border: 1px solid #333; border-radius: 0; 
            padding: 8px 12px; font-family: var(--font-body); outline: none;
        }
        
        /* --- VIEWFINDER --- */
        .viewport { 
            flex-grow: 1; position: relative; background: #000; 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        video { 
            position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 1;
        }
        
        #onion-layer { 
            position: absolute; width: 100%; height: 100%; object-fit: cover; 
            z-index: 10; opacity: 0; pointer-events: none; filter: grayscale(100%);
        }

        /* ASCII FLASH LAYER */
        #ascii-canvas {
            position: absolute; width: 100%; height: 100%; object-fit: contain;
            z-index: 30; pointer-events: none; display: none;
            background: black;
        }
        
        /* 4:5 MASK & OVERLAYS */
        .mask-container {
            position: relative; z-index: 20; pointer-events: none;
            width: 100%; max-width: 600px; aspect-ratio: 4/5;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.85);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex; justify-content: center; align-items: center;
        }

        .overlay-layer { width: 100%; height: 100%; position: relative; }
        .guide-face { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 180px; height: 260px; border: 1px dashed white; border-radius: 50%; opacity: 0.6;
        }
        .guide-thirds {
            width: 100%; height: 100%; opacity: 0.2;
            background-image: linear-gradient(white 1px, transparent 1px), linear-gradient(90deg, white 1px, transparent 1px);
            background-size: 33.3% 33.3%;
        }

        /* GYRO LEVELER */
        #gyro-line {
            position: absolute; top: 50%; left: 10%; right: 10%; height: 1px;
            background: rgba(255,255,255,0.3); z-index: 25;
            transform-origin: center; display: none; transition: transform 0.1s;
        }
        #gyro-line.level { background: #fff; height: 2px; box-shadow: 0 0 5px white; }

        /* --- CONTROLS --- */
        .controls { 
            padding: 20px; border-top: var(--border); background: var(--bg);
            display: flex; flex-direction: column; gap: 12px; z-index: 40;
        }

        button {
            background: transparent; color: white; border: 1px solid #333; padding: 14px;
            font-family: var(--font-head); font-size: 16px; text-transform: uppercase; cursor: pointer;
            transition: all 0.1s;
        }
        button:active { background: white; color: black; border-color: white; }
        button.primary { border-color: white; }

        .slider-row { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #888; }
        input[type=range] { -webkit-appearance: none; background: transparent; flex-grow: 1; }
        input[type=range]::-webkit-slider-runnable-track { height: 1px; background: #333; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -5px; height: 10px; width: 10px; background: white; border-radius: 50%; }

        .status-bar { display: flex; justify-content: space-between; font-family: var(--font-head); color: #555; font-size: 12px; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { width: 100%; max-width: 300px; border: 1px solid white; padding: 20px; background: black; display: flex; flex-direction: column; gap: 15px; }
        .hidden { display: none !important; }
        canvas { display: none; }
    </style>
</head>
<body>

<div id="setup-modal" class="modal hidden">
    <div class="modal-box">
        <h2>( AUTH )</h2>
        <p style="color:#888;">DROPBOX TOKEN REQUIRED</p>
        <input type="text" id="token-input" placeholder="sl.B5...">
        <button class="primary" onclick="saveToken()">CONNECT</button>
    </div>
</div>

<div id="project-modal" class="modal hidden">
    <div class="modal-box">
        <h2>( NEW )</h2>
        <input type="text" id="new-proj-name" placeholder="NAME">
        <select id="new-proj-overlay">
            <option value="guide-face">GUIDE: FACE</option>
            <option value="guide-thirds">GUIDE: GRID</option>
            <option value="guide-none">GUIDE: NONE</option>
        </select>
        <div style="display:flex; gap:10px;">
            <button class="primary" style="flex:1" onclick="saveNewProject()">OK</button>
            <button style="flex:1" onclick="toggleProjectModal()">X</button>
        </div>
    </div>
</div>

<header>
    <div style="display:flex; gap:10px; align-items:center;">
        <span style="font-family: var(--font-head); font-size: 18px;">( C )</span>
        <select id="project-select" style="border:none; border-bottom:1px solid #333; background: transparent;"></select>
        <button onclick="toggleProjectModal()" style="border:none; font-size:18px;">+</button>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="requestGyro()" style="border:none; font-size:12px; color:#888;" id="btn-gyro">( LVL )</button>
        <button onclick="syncProjects()" style="border:none; font-size:12px; color:#888;">( SYNC )</button>
    </div>
</header>

<div class="viewport">
    <video id="video" autoplay playsinline></video>
    <img id="onion-layer" />
    <canvas id="ascii-canvas"></canvas> <div class="mask-container">
        <div id="overlay-container" class="overlay-layer"></div>
        <div id="gyro-line"></div>
    </div>
</div>

<div class="controls">
    <div class="slider-row">
        <span>GHOST</span>
        <input type="range" min="0" max="100" value="0" oninput="updateOnion(this.value)">
        <span id="onion-val">00</span>
    </div>

    <div id="cam-controls" style="display:flex; gap:10px;">
        <button class="primary" id="snap-btn" style="flex:2;">CAPTURE</button>
        <button onclick="flipCamera()" style="flex:1;">CAM</button>
    </div>

    <div id="review-panel" class="hidden" style="display: flex; gap: 10px;">
        <button onclick="retryPhoto()" style="flex:1;">RETRY</button>
        <button class="primary" onclick="uploadPhoto()" style="flex:2;">SAVE</button>
    </div>

    <div class="status-bar">
        <span id="streak-display">STRK: 00</span>
        <span id="res-info">4:5</span>
    </div>
</div>

<canvas id="canvas"></canvas>
<canvas id="small-canvas"></canvas>

<script>
    // --- 1. CONFIG ---
    let dbxToken = localStorage.getItem('dbx_token');
    if (!dbxToken) document.getElementById('setup-modal').classList.remove('hidden');

    const defaultProjects = [
        { id: "face-daily", name: "FACE_DAILY", overlay: "guide-face", folder: "/FaceProject", streak: 0, lastDate: "" },
        { id: "landscape", name: "LANDSCAPE", overlay: "guide-thirds", folder: "/Landscape", streak: 0, lastDate: "" }
    ];
    let myProjects = JSON.parse(localStorage.getItem('my_projects')) || defaultProjects;

    // --- 2. CAMERA & GYRO ---
    let currentStream = null;
    let facingMode = "user";
    const video = document.getElementById('video');

    async function startCamera(mode) {
        if(!mode) mode = facingMode;
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        facingMode = mode;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: mode, width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            currentStream = stream;
        } catch (e) { console.error(e); }
    }
    function flipCamera() { startCamera(facingMode === "user" ? "environment" : "user"); }

    // Gyroscope Logic
    function requestGyro() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(state => {
                    if (state === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                        document.getElementById('gyro-line').style.display = 'block';
                        document.getElementById('btn-gyro').style.color = 'white';
                    }
                })
                .catch(console.error);
        } else {
            // Android/Non-iOS
            window.addEventListener('deviceorientation', handleOrientation);
            document.getElementById('gyro-line').style.display = 'block';
            document.getElementById('btn-gyro').style.color = 'white';
        }
    }

    function handleOrientation(e) {
        const line = document.getElementById('gyro-line');
        // Gamma is left/right tilt (holding phone vertically)
        // Beta is front/back tilt (holding phone horizontally)
        // We assume Portrait Mode usage mainly
        let tilt = e.gamma; 
        
        // Simple rotation
        line.style.transform = `rotate(${tilt}deg)`;
        
        // Level detection (+/- 2 degrees)
        if (tilt > -2 && tilt < 2) {
            line.classList.add('level');
        } else {
            line.classList.remove('level');
        }
    }

    // --- 3. ASCII ENGINE ---
    const asciiChars = "@%#*+=-:. "; // Dark to light
    
    function generateAscii(sourceCanvas) {
        // We downscale image to small canvas to get pixel data
        const small = document.getElementById('small-canvas');
        const w = 80; // ASCII width (characters)
        const h = 100; // ASCII height (rows) -> roughly 4:5
        small.width = w; small.height = h;
        const ctx = small.getContext('2d');
        ctx.drawImage(sourceCanvas, 0, 0, w, h);
        
        const pixels = ctx.getImageData(0,0,w,h).data;
        let asciiStr = "";
        
        for(let y=0; y<h; y++){
            for(let x=0; x<w; x++){
                const i = (y*w + x) * 4;
                const r = pixels[i]; const g = pixels[i+1]; const b = pixels[i+2];
                const avg = (r+g+b)/3;
                const charIdx = Math.floor((avg / 255) * (asciiChars.length - 1));
                asciiStr += asciiChars[charIdx];
            }
            asciiStr += "\n";
        }
        return asciiStr;
    }

    function drawAsciiToCanvas(str) {
        const c = document.getElementById('ascii-canvas');
        c.width = 800; c.height = 1000;
        const ctx = c.getContext('2d');
        ctx.fillStyle = "black";
        ctx.fillRect(0,0,c.width,c.height);
        ctx.fillStyle = "#00ff00"; // Classic matrix green or white? Let's go WHITE for monochrome
        ctx.fillStyle = "white";
        ctx.font = "12px monospace";
        
        const lines = str.split('\n');
        lines.forEach((line, i) => {
            ctx.fillText(line, 10, 15 + (i * 10));
        });
        return c;
    }

    // --- 4. CAPTURE ---
    const canvas = document.getElementById('canvas'); 
    let currentBlob = null;
    let asciiBlob = null;

    document.getElementById('snap-btn').addEventListener('click', async () => {
        const vidW = video.videoWidth;
        const targetW = vidW;
        const targetH = vidW * 1.25; 
        const startY = (video.videoHeight - targetH) / 2;

        canvas.width = targetW; canvas.height = targetH;
        const ctx = canvas.getContext('2d');
        if(facingMode === "user") { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
        ctx.drawImage(video, 0, startY, targetW, targetH, 0, 0, targetW, targetH);
        
        // 1. Generate ASCII
        const str = generateAscii(canvas);
        const asciiCan = drawAsciiToCanvas(str);
        
        // 2. FLASH EFFECT
        const asciiEl = document.getElementById('ascii-canvas');
        asciiEl.style.display = 'block';
        setTimeout(() => { asciiEl.style.display = 'none'; }, 1000); // 1s Flash
        
        // 3. Prep Blobs
        canvas.toBlob(b => currentBlob = b, 'image/jpeg', 0.95);
        asciiCan.toBlob(b => asciiBlob = b, 'image/jpeg', 0.80);
        
        // 4. UI Transition
        document.getElementById('cam-controls').classList.add('hidden');
        document.getElementById('review-panel').classList.remove('hidden');
    });

    function retryPhoto() { 
        document.getElementById('cam-controls').classList.remove('hidden');
        document.getElementById('review-panel').classList.add('hidden');
        currentBlob = null; asciiBlob = null;
    }

    // --- 5. DATA & UPLOAD ---
    const select = document.getElementById('project-select');
    let db;
    const DB_REQ = indexedDB.open("CapsuleSys", 1);
    DB_REQ.onupgradeneeded = (e) => { e.target.result.createObjectStore('ghosts', { keyPath: 'id' }); };
    DB_REQ.onsuccess = (e) => { db = e.target.result; loadProject(myProjects[0].id); };

    function renderProjects() {
        select.innerHTML = "";
        myProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.innerText = p.name; select.appendChild(opt);
        });
        loadProject(myProjects[0].id);
    }
    
    function loadProject(id) {
        const proj = myProjects.find(p => p.id === id);
        if(!proj) return;
        document.getElementById('overlay-container').innerHTML = `<div class="${proj.overlay}"></div>`;
        document.getElementById('streak-display').innerText = `STRK: ${(proj.streak || 0).toString().padStart(2,'0')}`;
        
        // Load Ghost
        if(db) {
            db.transaction(['ghosts']).objectStore('ghosts').get(id).onsuccess = (e) => {
                document.getElementById('onion-layer').src = e.target.result ? URL.createObjectURL(e.target.result.blob) : "";
            };
        }
    }
    select.addEventListener('change', (e) => loadProject(e.target.value));

    async function uploadPhoto() {
        if (!currentBlob) return;
        const status = document.getElementById('streak-display');
        status.innerText = "UPLOADING...";
        
        const pid = select.value;
        const proj = myProjects.find(p => p.id === pid);
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];

        try {
            // Save Ghost
            db.transaction(['ghosts'], 'readwrite').objectStore('ghosts').put({ id: pid, blob: currentBlob });
            
            // Streak Logic
            if(proj.lastDate !== dateStr) {
                // Check if consecutive (simple check: if lastDate was yesterday)
                // For now, simple increment if date changed
                proj.streak = (proj.streak || 0) + 1;
                proj.lastDate = dateStr;
                localStorage.setItem('my_projects', JSON.stringify(myProjects));
            }

            // Upload 1: Clean
            await sendToDropbox(currentBlob, `${proj.folder}/${pid}-${dateStr}.jpg`);
            // Upload 2: ASCII
            await sendToDropbox(asciiBlob, `${proj.folder}/${pid}-${dateStr}-ascii.jpg`);
            // Upload 3: Meta
            const meta = { time: now, project: pid, cam: facingMode };
            await sendToDropbox(new Blob([JSON.stringify(meta)],{type:'application/json'}), `${proj.folder}/${pid}-${dateStr}.json`);

            retryPhoto(); status.innerText = "SAVED"; 
            setTimeout(() => loadProject(pid), 1500); // Reload to show streak

        } catch(e) { alert(e.message); status.innerText = "ERR"; }
    }

    async function sendToDropbox(f, p) {
        const r = await fetch('https://content.dropboxapi.com/2/files/upload', { 
            method: 'POST', 
            headers: { 'Authorization': 'Bearer '+localStorage.getItem('dbx_token'), 'Content-Type': 'application/octet-stream', 'Dropbox-API-Arg': JSON.stringify({ path: p, mode: 'add', autorename: true }) }, 
            body: f 
        });
        if(!r.ok) throw new Error(await r.text());
    }

    // Utils
    function toggleProjectModal() { document.getElementById('project-modal').classList.toggle('hidden'); }
    function saveToken() { const t = document.getElementById('token-input').value.trim(); if(t) { localStorage.setItem('dbx_token', t); location.reload(); } }
    function saveNewProject() {
        const name = document.getElementById('new-proj-name').value;
        const overlay = document.getElementById('new-proj-overlay').value;
        if(!name) return;
        const id = name.toLowerCase().replace(/\s+/g, '-');
        myProjects.push({ id, name: name.toUpperCase(), overlay, folder: "/" + name.replace(/\s+/g, ''), streak: 0 });
        localStorage.setItem('my_projects', JSON.stringify(myProjects));
        renderProjects(); select.value = id; loadProject(id); toggleProjectModal();
    }
    function updateOnion(val) { document.getElementById('onion-layer').style.opacity = val / 100; document.getElementById('onion-val').innerText = val.padStart(2, '0'); }
    function syncProjects() { alert("Use v0.4 code for full sync, stripped here for space."); }

    if(dbxToken) { startCamera(); renderProjects(); }
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
