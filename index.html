<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CAPSULE.EXE</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        /* --- DOS / KEYGEN AESTHETICS --- */
        :root {
            --term-green: #33ff00;
            --term-dim: #1a8000;
            --term-bg: #000000;
            --font-stack: 'VT323', monospace;
        }

        body { 
            margin: 0; background: var(--term-bg); color: var(--term-green); 
            font-family: var(--font-stack); font-size: 20px; text-transform: uppercase;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            letter-spacing: 1px;
        }

        /* --- LAYOUT --- */
        header { 
            padding: 10px; border-bottom: 2px solid var(--term-green);
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--term-bg); z-index: 20;
        }

        .viewport { 
            flex-grow: 1; position: relative; background: #111; 
            border-left: 2px solid var(--term-green);
            border-right: 2px solid var(--term-green);
        }
        
        /* The Camera Feed (RAW) */
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        
        /* Onion Skin Layer */
        #onion-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; pointer-events: none; z-index: 8;
            filter: grayscale(100%); /* Optional: makes ghost image B&W for clarity */
        }

        /* Overlays (Guides) */
        .overlay-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0.7; }
        .guide-face { 
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); 
            width: 200px; height: 280px; 
            border: 2px dashed var(--term-green); border-radius: 50%; 
        }
        .guide-thirds { 
            width: 100%; height: 100%;
            background: linear-gradient(to right, transparent 33%, var(--term-dim) 33%, var(--term-dim) 33.5%, transparent 33.5%, transparent 66%, var(--term-dim) 66%, var(--term-dim) 66.5%, transparent 66.5%),
                        linear-gradient(to bottom, transparent 33%, var(--term-dim) 33%, var(--term-dim) 33.5%, transparent 33.5%, transparent 66%, var(--term-dim) 66%, var(--term-dim) 66.5%, transparent 66.5%);
        }

        /* Controls Area */
        .controls { 
            padding: 20px; border-top: 2px solid var(--term-green); background: var(--term-bg);
            display: flex; flex-direction: column; gap: 10px; z-index: 20;
        }

        /* --- UI ELEMENTS (The "Keygen" Look) --- */
        button {
            background: var(--term-bg); color: var(--term-green);
            border: 2px solid var(--term-green); padding: 10px;
            font-family: var(--font-stack); font-size: 22px; cursor: pointer;
            box-shadow: 4px 4px 0px var(--term-dim);
        }
        button:active { box-shadow: 1px 1px 0px var(--term-dim); transform: translate(3px, 3px); }

        select, input {
            background: var(--term-bg); color: var(--term-green);
            border: 1px solid var(--term-green); padding: 5px;
            font-family: var(--font-stack); font-size: 18px;
        }

        /* Top Bar Info */
        .sys-info { font-size: 16px; color: var(--term-dim); }
        .sys-info span { color: var(--term-green); }

        /* Sliders */
        .range-wrap { display: flex; align-items: center; gap: 10px; font-size: 16px; margin-bottom: 5px; }
        input[type=range] { flex-grow: 1; accent-color: var(--term-green); }

        /* Modals */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border: 4px double var(--term-green); padding: 20px;
        }
        .ascii-art { white-space: pre; font-size: 10px; line-height: 10px; margin-bottom: 20px; color: var(--term-dim); text-align: center; }

        .hidden { display: none !important; }
        
        /* Capture Button Special Style */
        .btn-capture { 
            align-self: center; width: 100%; max-width: 300px;
            text-align: center; font-weight: bold; letter-spacing: 3px;
        }
    </style>
</head>
<body>

<div id="setup-modal" class="modal hidden">
    <div class="ascii-art">
   _____          _____  _____ __  __ __ 
  / ____|   /\   |  __ \/ ____|  \/  |  |
 | |       /  \  | |__) | (___ | \  / |  |
 | |      / /\ \ |  ___/ \___ \| |\/| |  |
 | |____ / ____ \| |     ____) | |  | |__|
  \_____/_/    \_\_|    |_____/|_|  |_(__)
    </div>
    <p>> ENTER_DROPBOX_TOKEN:</p>
    <input type="text" id="token-input" placeholder="sl.B5..." style="width: 80%;">
    <br>
    <button onclick="saveToken()">[ INITIALIZE ]</button>
</div>

<div id="project-modal" class="modal hidden">
    <h2>> CREATE_NEW_PROJECT</h2>
    <input type="text" id="new-proj-name" placeholder="PROJECT_NAME" style="width: 80%;">
    <br>
    <select id="new-proj-overlay" style="width: 80%;">
        <option value="guide-face">OVERLAY: FACE</option>
        <option value="guide-thirds">OVERLAY: GRID</option>
        <option value="guide-none">OVERLAY: NULL</option>
    </select>
    <br><br>
    <div style="display:flex; gap:10px;">
        <button onclick="saveNewProject()">[ EXECUTE ]</button>
        <button onclick="toggleProjectModal()" style="border-color: #555; color: #555;">[ ABORT ]</button>
    </div>
</div>

<header>
    <div style="display:flex; gap:10px; align-items:center;">
        <span style="font-size: 24px;">></span>
        <select id="project-select"></select>
        <button onclick="toggleProjectModal()" style="padding: 2px 8px;">+</button>
    </div>
    <div class="sys-info">CAM:<span id="cam-status">OFF</span></div>
</header>

<div class="viewport">
    <img id="onion-layer" />
    
    <video id="video" autoplay playsinline></video>
    
    <canvas id="canvas"></canvas>
    
    <div id="overlay-container" class="overlay-layer"></div>
</div>

<div class="controls">
    <div class="range-wrap">
        <span>GHOST:</span>
        <input type="range" id="onion-slider" min="0" max="100" value="0" oninput="updateOnion(this.value)">
        <span id="onion-val">0%</span>
    </div>

    <div id="cam-controls">
        <button id="snap-btn" class="btn-capture">[ CAPTURE_FRAME ]</button>
        <div style="display:flex; justify-content: space-between; margin-top: 10px;">
            <button onclick="flipCamera()" style="font-size: 16px;">[ FLIP_CAM ]</button>
            <span id="status-msg" style="align-self: center; font-size: 14px;">READY</span>
        </div>
    </div>

    <div id="review-panel" class="hidden" style="display: flex; gap: 10px;">
        <button onclick="retryPhoto()" style="flex:1; border-color: red; color: red;">[ DISCARD ]</button>
        <button onclick="uploadPhoto()" style="flex:1;">[ UPLOAD_DATA ]</button>
    </div>
</div>

<script>
    // --- 1. SYSTEM INIT ---
    let dbxToken = localStorage.getItem('dbx_token');
    if (!dbxToken) document.getElementById('setup-modal').classList.remove('hidden');

    const defaultProjects = [
        { id: "face-daily", name: "FACE_DAILY", overlay: "guide-face", folder: "/FaceProject" },
        { id: "landscape", name: "LANDSCAPE", overlay: "guide-thirds", folder: "/Landscape" }
    ];
    let myProjects = JSON.parse(localStorage.getItem('my_projects')) || defaultProjects;

    // --- 2. INDEXED DB (Memory System) ---
    // We use this to store the "Ghost" images locally without re-downloading them
    let db;
    const DB_REQ = indexedDB.open("CapsuleDB", 1);
    
    DB_REQ.onupgradeneeded = (e) => {
        let db = e.target.result;
        if (!db.objectStoreNames.contains('ghosts')) {
            db.createObjectStore('ghosts', { keyPath: 'id' });
        }
    };
    DB_REQ.onsuccess = (e) => { db = e.target.result; loadGhost(select.value); };

    function saveGhost(projectId, blob) {
        if(!db) return;
        const tx = db.transaction(['ghosts'], 'readwrite');
        tx.objectStore('ghosts').put({ id: projectId, blob: blob });
    }

    function loadGhost(projectId) {
        if(!db) return;
        const tx = db.transaction(['ghosts'], 'readonly');
        const req = tx.objectStore('ghosts').get(projectId);
        req.onsuccess = (e) => {
            if (req.result) {
                const url = URL.createObjectURL(req.result.blob);
                document.getElementById('onion-layer').src = url;
            } else {
                document.getElementById('onion-layer').src = "";
            }
        };
    }

    // --- 3. ONION SKIN ---
    function updateOnion(val) {
        document.getElementById('onion-layer').style.opacity = val / 100;
        document.getElementById('onion-val').innerText = val + "%";
    }

    // --- 4. CAMERA & PROJECT LOGIC ---
    let currentStream = null;
    let facingMode = "user"; // Default to selfie
    const video = document.getElementById('video');
    const select = document.getElementById('project-select');

    async function startCamera(mode) {
        if(!mode) mode = facingMode;
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        facingMode = mode;
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: mode, width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
            currentStream = stream;
            document.getElementById('cam-status').innerText = "ON";
        } catch (e) {
            document.getElementById('cam-status').innerText = "ERR";
        }
    }
    
    function flipCamera() { startCamera(facingMode === "user" ? "environment" : "user"); }

    function renderProjects() {
        select.innerHTML = "";
        myProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.innerText = p.name; select.appendChild(opt);
        });
        loadProject(myProjects[0].id);
    }

    function loadProject(id) {
        const proj = myProjects.find(p => p.id === id);
        if(!proj) return;
        document.getElementById('overlay-container').className = "overlay-layer " + proj.overlay;
        loadGhost(id); // Try to find previous photo
    }

    select.addEventListener('change', (e) => loadProject(e.target.value));

    // --- 5. CAPTURE & UPLOAD ---
    const canvas = document.getElementById('canvas'); 
    let currentBlob = null;

    document.getElementById('snap-btn').addEventListener('click', () => {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        if(facingMode === "user") { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
        ctx.drawImage(video, 0, 0);
        
        canvas.style.display = 'block'; 
        document.getElementById('cam-controls').classList.add('hidden');
        document.getElementById('review-panel').classList.remove('hidden');
        canvas.toBlob(b => currentBlob = b, 'image/jpeg', 0.95);
    });

    function retryPhoto() { 
        canvas.style.display = 'none'; 
        document.getElementById('cam-controls').classList.remove('hidden');
        document.getElementById('review-panel').classList.add('hidden');
        currentBlob = null; 
    }

    async function uploadPhoto() {
        if (!currentBlob) return;
        const status = document.getElementById('status-msg');
        status.innerText = "UPLOADING...";
        
        const pid = select.value;
        const proj = myProjects.find(p => p.id === pid);
        const today = new Date().toISOString().split('T')[0];

        try {
            // 1. Save locally for next time (The Onion Skin)
            saveGhost(pid, currentBlob);

            // 2. Metadata
            let temp = "N/A";
            try {
                const pos = await new Promise((r, j) => navigator.geolocation.getCurrentPosition(r, j, {timeout:2000}));
                const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`)).json();
                temp = w.current_weather.temperature + "C";
            } catch(e){}

            // 3. Upload
            await sendToDropbox(currentBlob, `${proj.folder}/${pid}-${today}.jpg`);
            const meta = { date: today, project: pid, temp: temp, cam: facingMode };
            await sendToDropbox(new Blob([JSON.stringify(meta)],{type:'application/json'}), `${proj.folder}/${pid}-${today}.json`);

            alert("DATA_SAVED_SUCCESSFULLY"); 
            retryPhoto(); 
            status.innerText = "READY";
        } catch(e) { 
            alert("FATAL_ERROR: "+e.message); 
            status.innerText = "FAIL";
        }
    }

    async function sendToDropbox(f, p) {
        const r = await fetch('https://content.dropboxapi.com/2/files/upload', { 
            method: 'POST', 
            headers: { 'Authorization': 'Bearer '+localStorage.getItem('dbx_token'), 'Content-Type': 'application/octet-stream', 'Dropbox-API-Arg': JSON.stringify({ path: p, mode: 'add', autorename: true }) }, 
            body: f 
        });
        if(!r.ok) throw new Error(await r.text());
    }

    // Modal Logic
    function toggleProjectModal() { document.getElementById('project-modal').classList.toggle('hidden'); }
    function saveToken() { const t = document.getElementById('token-input').value.trim(); if(t) { localStorage.setItem('dbx_token', t); location.reload(); } }
    function saveNewProject() {
        const name = document.getElementById('new-proj-name').value;
        const overlay = document.getElementById('new-proj-overlay').value;
        if(!name) return;
        const id = name.toLowerCase().replace(/\s+/g, '-');
        myProjects.push({ id, name: name.toUpperCase(), overlay, folder: "/" + name.replace(/\s+/g, '') });
        localStorage.setItem('my_projects', JSON.stringify(myProjects));
        renderProjects(); select.value = id; loadProject(id); toggleProjectModal();
    }

    // Boot
    if(dbxToken) { startCamera(); renderProjects(); }
    if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
